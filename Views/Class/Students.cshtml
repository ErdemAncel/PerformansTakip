@model List<PerformansTakip.Models.Student>

@{
    ViewData["Title"] = ViewBag.ClassName + " - Öğrenci Listesi";
    var trackingType = ViewBag.TrackingType;
    var classId = ViewContext.RouteData.Values["id"];
}

<style>
    /* Toast Bildirimleri */
    .toast-container {
        z-index: 1050;
    }
    .toast {
        min-width: 350px;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border-radius: 0.5rem;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }
    .toast.success {
        background-color: #28a745;
    }
    .toast.error {
        background-color: #dc3545;
    }
    .toast.warning {
        background-color: #ffc107;
    }
    .toast.info {
        background-color: #17a2b8;
    }
    .toast-icon {
        font-size: 1.5rem;
        color: white;
    }
    .toast-body {
        font-size: 0.95rem;
        color: white;
    }
    .progress {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: rgba(255,255,255,0.2);
        border-radius: 0;
    }
    .progress-bar {
        background-color: white;
        transition: width 2s linear;
    }
    @@keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    .toast {
        animation: slideIn 0.3s ease-out;
    }

    /* Genel Tasarım İyileştirmeleri */
    .container {
        max-width: 1200px;
    }
    .table {
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }
    .btn {
        border-radius: 0.25rem;
        padding: 0.375rem 0.75rem;
        font-weight: 500;
        transition: all 0.2s ease-in-out;
    }
    .btn-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    .btn-primary:hover {
        background-color: #0b5ed7;
        border-color: #0a58ca;
    }
    .btn-success {
        background-color: #198754;
        border-color: #198754;
    }
    .btn-success:hover {
        background-color: #157347;
        border-color: #146c43;
    }
    .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
    }
    .btn-danger:hover {
        background-color: #bb2d3b;
        border-color: #b02a37;
    }
    .form-control {
        border-radius: 0.25rem;
        border: 1px solid #ced4da;
        padding: 0.375rem 0.75rem;
    }
    .form-control:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    .modal-content {
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        border-radius: 0.5rem 0.5rem 0 0;
    }
    .alert {
        border-radius: 0.5rem;
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
</style>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">@ViewBag.ClassName - Öğrenci Listesi</h2>
        <div>
            <button type="button" class="btn btn-danger me-2" onclick="deleteAllStudents()">
                <i class="fas fa-trash"></i> Tüm Öğrencileri Sil
            </button>
            <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                <i class="fas fa-plus"></i> Yeni Öğrenci Ekle
            </button>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#bulkAddModal">
                <i class="fas fa-users"></i> Toplu Öğrenci Ekle
            </button>
        </div>
    </div>

    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i> Bu sınıfta henüz öğrenci bulunmamaktadır.
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Öğrenci No</th>
                        <th>Ad Soyad</th>
                        @if (trackingType == "uniform")
                        {
                            <th>Kıyafet Durumu</th>
                        }
                        else if (trackingType == "homework")
                        {
                            <th>Ödev Durumu</th>
                        }
                        else if (trackingType == "performance")
                        {
                            <th>Performans Puanı</th>
                        }
                        <th>Son Güncelleme</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var student in Model)
                    {
                        <tr>
                            <td>@student.Id</td>
                            <td>@student.FirstName @student.LastName</td>
                            @if (trackingType == "uniform")
                            {
                                <td>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input uniform-status" type="checkbox" 
                                               data-student-id="@student.Id"
                                               @(student.UniformStatus ? "checked" : "")>
                                        <label class="form-check-label">
                                            @(student.UniformStatus ? "Uygun" : "Uygun Değil")
                                        </label>
                                    </div>
                                </td>
                            }
                            else if (trackingType == "homework")
                            {
                                <td>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input homework-status" type="checkbox" 
                                               data-student-id="@student.Id"
                                               @(student.HomeworkStatus ? "checked" : "")>
                                        <label class="form-check-label">
                                            @(student.HomeworkStatus ? "Tamamlandı" : "Tamamlanmadı")
                                        </label>
                                    </div>
                                </td>
                            }
                            else if (trackingType == "performance")
                            {
                                <td>
                                    <div class="input-group">
                                        <input type="number" 
                                               class="form-control performance-score" 
                                               data-student-id="@student.Id"
                                               value="@student.PerformanceScore" 
                                               min="0" 
                                               max="100"
                                               style="font-size: 1.25rem; text-align: center;"
                                               onfocus="this.select()">
                                        <button class="btn btn-outline-primary score-save-btn" 
                                                data-student-id="@student.Id"
                                                style="display: none;">
                                            <i class="fas fa-save"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted mobile-warning" style="display: none;">
                                        <i class="fas fa-exclamation-triangle"></i> Lütfen puan girişini bilgisayardan yapın
                                    </small>
                                </td>
                            }
                            <td>@student.LastUpdated.ToString("dd.MM.yyyy HH:mm")</td>
                            <td>
                                <button type="button" class="btn btn-danger btn-sm" onclick="deleteStudent(@student.Id)">
                                    <i class="fas fa-trash"></i> Sil
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<!-- Modals -->
<div class="modal fade" id="addStudentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Yeni Öğrenci Ekle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addStudentForm">
                    <input type="hidden" id="classId" value="@ViewBag.ClassId" />
                    <div class="mb-3">
                        <label class="form-label">Ad</label>
                        <input type="text" class="form-control" id="firstName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Soyad</label>
                        <input type="text" class="form-control" id="lastName" required>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                        <button type="submit" class="btn btn-primary">Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bulkAddModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Toplu Öğrenci Ekle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Her satıra bir öğrenci bilgisi girin. Format: Ad Soyad
                </div>
                <div class="mb-3">
                    <textarea class="form-control" id="bulkStudentNames" rows="10" placeholder="Örnek:
Ahmet Yılmaz
Ayşe Demir
Mehmet Kaya"></textarea>
                </div>
                <div class="text-end">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" onclick="addBulkStudents()">Kaydet</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Öğrenci ekleme formu
            $('#addStudentForm').on('submit', function(e) {
                e.preventDefault();
                
                var student = {
                    ClassId: parseInt($('#classId').val()),
                    FirstName: $('#firstName').val(),
                    LastName: $('#lastName').val()
                };
                
                $.ajax({
                    url: '/Class/AddStudent',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(student),
                    success: function(response) {
                        if (response.success) {
                            $('#addStudentModal').modal('hide');
                            location.reload();
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Bir hata oluştu: ' + error);
                    }
                });
            });

            // Kıyafet durumu güncelleme
            $('.uniform-status').change(function() {
                var studentId = $(this).data('student-id');
                var status = $(this).prop('checked');
                updateUniformStatus(studentId, status);
            });

            // Ödev durumu güncelleme
            $('.homework-status').change(function() {
                var studentId = $(this).data('student-id');
                var status = $(this).prop('checked');
                updateHomeworkStatus(studentId, status);
            });

            // Mobil cihaz kontrolü
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Mobil cihazlarda input alanlarını devre dışı bırak ve uyarı göster
                $('.performance-score').prop('readonly', true);
                $('.mobile-warning').show();
                
                // Input alanına tıklandığında uyarı göster
                $('.performance-score').on('focus', function() {
                    showToast('Lütfen puan girişini bilgisayardan yapın', 'warning');
                });
            }

            // Performans puanı girişi için event listener'lar
            $('.performance-score').on('input', function() {
                if (!isMobile) {
                    const saveBtn = $(this).siblings('.score-save-btn');
                    saveBtn.show();
                }
            });

            $('.score-save-btn').on('click', function() {
                if (!isMobile) {
                    const studentId = $(this).data('student-id');
                    const score = $(this).siblings('.performance-score').val();
                    updatePerformanceScore(studentId, score);
                    $(this).hide();
                }
            });

            // Enter tuşu ile kaydetme
            $('.performance-score').on('keypress', function(e) {
                if (!isMobile && e.which === 13) {
                    const studentId = $(this).data('student-id');
                    const score = $(this).val();
                    updatePerformanceScore(studentId, score);
                    $(this).siblings('.score-save-btn').hide();
                    e.preventDefault();
                }
            });

            // Input alanından çıkıldığında kaydetme
            $('.performance-score').on('blur', function() {
                if (!isMobile) {
                    const studentId = $(this).data('student-id');
                    const score = $(this).val();
                    if (score !== '') {
                        updatePerformanceScore(studentId, score);
                        $(this).siblings('.score-save-btn').hide();
                    }
                }
            });
        });

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white ${type} border-0 position-fixed top-0 end-0 m-3`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            const icon = type === 'success' ? 'check-circle' :
                        type === 'error' ? 'exclamation-circle' :
                        type === 'warning' ? 'exclamation-triangle' : 'info-circle';
            
            const delay = type === 'success' ? 2000 : 3000;
            
            toast.innerHTML = `
                <div class="position-relative">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 100%"></div>
                    </div>
                    <div class="d-flex align-items-center p-3">
                        <div class="toast-icon me-3">
                            <i class="fas fa-${icon}"></i>
                        </div>
                        <div class="toast-body flex-grow-1">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white ms-2" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            toastContainer.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast, {
                autohide: true,
                delay: delay
            });
            
            const progressBar = toast.querySelector('.progress-bar');
            progressBar.style.width = '0%';
            setTimeout(() => {
                progressBar.style.width = '100%';
            }, 10);
            
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', function() {
                toast.remove();
                if (toastContainer.children.length === 0) {
                    toastContainer.remove();
                }
            });
        }

        function addBulkStudents() {
            const classId = @ViewBag.ClassId;
            const studentNamesText = $('#bulkStudentNames').val().trim();
            
            if (!studentNamesText) {
                showToast('Lütfen en az bir öğrenci bilgisi girin.', 'warning');
                return;
            }

            const studentNames = studentNamesText.split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0);

            if (studentNames.length === 0) {
                showToast('Lütfen geçerli öğrenci bilgileri girin.', 'warning');
                return;
            }

            const invalidNames = studentNames.filter(name => {
                const parts = name.split(' ');
                return parts.length < 2 || parts.some(part => part.length < 2);
            });

            if (invalidNames.length > 0) {
                showToast(`Geçersiz öğrenci formatı: ${invalidNames.join(', ')}. Her öğrenci için ad ve soyad giriniz.`, 'error');
                return;
            }

            showToast('Öğrenciler ekleniyor...', 'info');

            $.ajax({
                url: '/Class/AddMultipleStudents',
                type: 'POST',
                data: JSON.stringify({
                    classId: classId,
                    studentNames: studentNames
                }),
                contentType: 'application/json',
                success: function(response) {
                    if (response.success) {
                        $('#bulkAddModal').modal('hide');
                        showToast('Öğrenciler başarıyla eklendi!', 'success');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('Hata: ' + response.message, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    showToast('Bir hata oluştu! Lütfen tekrar deneyin.', 'error');
                }
            });
        }

        function updateUniformStatus(studentId, status) {
            $.post('/Class/UpdateUniform', { studentId: studentId, status: status })
                .done(function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Güncelleme başarısız: ' + response.message);
                    }
                });
        }

        function updateHomeworkStatus(studentId, status) {
            $.post('/Class/UpdateHomework', { studentId: studentId, status: status })
                .done(function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Güncelleme başarısız: ' + response.message);
                    }
                });
        }

        function updatePerformanceScore(studentId, score) {
            if (score === '') return;
            
            const numericScore = parseInt(score);
            if (isNaN(numericScore) || numericScore < 0 || numericScore > 100) {
                showToast('Lütfen 0-100 arası geçerli bir puan girin', 'error');
                return;
            }

            $.post('/Class/UpdatePerformance', { studentId: studentId, score: numericScore })
                .done(function(response) {
                    if (response.success) {
                        showToast('Puan başarıyla güncellendi', 'success');
                    } else {
                        showToast('Güncelleme başarısız: ' + response.message, 'error');
                    }
                })
                .fail(function() {
                    showToast('Bir hata oluştu', 'error');
                });
        }

        function deleteStudent(studentId) {
            if (!confirm('Bu öğrenciyi silmek istediğinizden emin misiniz?')) {
                return;
            }

            $.post('/Class/DeleteStudent', { studentId: studentId })
                .done(function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Silme işlemi başarısız: ' + response.message);
                    }
                });
        }

        function deleteAllStudents() {
            if (!confirm('Tüm öğrencileri silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!')) {
                return;
            }

            const classId = @ViewBag.ClassId;

            $.ajax({
                url: '/Class/DeleteAllStudents',
                type: 'POST',
                data: { classId: classId },
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Hata: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    alert('Bir hata oluştu!');
                }
            });
        }
    </script>
} 